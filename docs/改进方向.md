# 改进方向与实施路线图（面向下一步工作）

本文档聚焦“提升 SSIM/LPIPS 的感知质量，同时保持推理实时性”。给出明确目标、优先级、技术路径、实施步骤、评估与验收标准，指导后续开发。

## 1. 目标与约束

- 质量目标：在不降低（或小幅降低）PSNR 的前提下，显著提升 SSIM 与 LPIPS（LPIPS 越低越好）。
- 实时约束：保持单张图整图渲染实时（GPU 上 1080p 目标 < 30ms 为理想线，< 60ms 可接受；CPU 视平台放宽）。
- 工程约束：分阶段、小步快跑，优先低风险高收益项；所有改动可通过开关启用/禁用，不破坏现有流程。

## 2. 优先级与分阶段实施

Phase A（低风险，先做）
- A1 统一产物目录（已完成）：所有输出到 `runs/`，避免目录混乱。
- A2 引入训练器边界（已完成）：`src/trainers/trainer.py`，便于后续挂载验证/指标/AMP。
- A3 轻量 CNN 基准图特征（BaselineEncoder，准备就绪）：`src/models/encoders.py` 已提供模块，下一步接入训练/推理（开关控制）。

Phase B（质量提升，控制成本）
- B1 Patch 级训练 + SSIM loss（先不加 LPIPS）：在 patch 上计算 1-SSIM，与 MSE 组合；小规模验证收益与收敛。
- B2 加入 LPIPS（可稀疏/低频）：在训练中每 N step 或每 epoch 若干 batch 计算 LPIPS，控制额外开销。

Phase C（进一步优化与加速）
- C1 FiLM 条件调制：以更小 time 编码驱动层内调制，降维降参。
- C2 哈希网格嵌入（进阶）：2D+Time 多分辨率哈希嵌入 + 小 MLP，极高实时性，工程成本较高。

## 3. 两条核心技术路径（均能提升 SSIM/LPIPS）

### 3.1 Patch 级训练（直接优化感知质量）
- 原理：loss 定义在局部区域（例如 16×16/32×32），SSIM/LPIPS 有意义；优化结构连续性与纹理一致性。
- 优点：直接面向目标指标优化；效果显著。
- 代价：训练计算更重（尤其 LPIPS），实现复杂度中等；推理成本不变。
- 建议起点：
	- patch_size: 16 或 32
	- loss: `loss = w_l2*MSE + w_ssim*(1-SSIM) [+ w_lpips*LPIPS]`
	- 初始权重：`w_l2=1.0, w_ssim=0.2, w_lpips=0.1`（先不启 LPIPS）

### 3.2 CNN 预计算基准图特征 + 小 MLP（性价比高）
- 原理：对 baseline.png 做一次浅层 CNN 编码成特征图 F0，训练/推理时按像素采样 F0(x,y) 特征 + 时间特征 → 小 MLP 输出 ΔRGB。
- 优点：为每像素提供上下文，显著减轻 MLP 负担，常带来 SSIM/LPIPS 提升；推理几乎不变（特征采样 + 小 MLP）。
- 代价：新增一次性编码；内存占用略增（可 downsample 或 fp16）。
- 建议起点：`out_ch=32, downsample=1 或 2`，MLP hidden 可降至 32~64。

## 4. 接口设计与代码改动（草案）

为保持开关式渐进改造，建议新增以下 CLI 参数（暂不默认开启）：

- CNN 基准图特征
	- `--use_baseline_encoder`（bool）
	- `--be_channels 32`、`--be_downsample 1`

- Patch 级训练（仅训练路径生效）
	- `--patch_size 0`（=0 关闭；>0 开启 patch 模式）
	- `--loss_ssim_w 0.2`、`--loss_lpips_w 0.0`（先从 0 启动，再逐步加）
	- `--lpips_freq 0`（0 关闭；>0 表示每 N step 计算一次 LPIPS）

模块落点：
- `src/models/encoders.py`：BaselineEncoder（已就绪）。
- `src/trainers/trainer.py`：增添可插拔的 loss 组装与验证钩子（回调式）。
- `src/data/lightmap_dataset.py`：新增 patch 模式（返回 patch 坐标网格与 GT 小块）。
- `scripts/train.py`：解析新参数，组装模型/损失/回调。

## 5. 实施步骤（可直接执行）

Step A：接入 CNN BaselineEncoder（预计 0.5 天）
1) 训练开始载入 baseline.png → Tensor[B,3,H,W]；送入 BaselineEncoder 得到 F0。[B,C,H',W']
2) 训练/推理时，将采样的 (x,y) 转为特征图坐标，使用 `grid_sample` 双线性采样得到 f(x,y)。
3) 模型输入由 `[encoded_xy, encoded_time]` 改为 `[f(x,y), encoded_time]` 或拼接。
4) 通过开关 `--use_baseline_encoder` 控制；默认关闭以保持旧行为。

Step B：实现 Patch 级训练框架（预计 1 天）
1) dataset 支持 `patch_size>0` 时返回 patch 内部所有像素的 (xy,t) 与 GT patch。
2) 训练时 reshape/拼 batch 前向，重构为 [B,C,H_p,W_p] 以便 SSIM/LPIPS 计算。
3) 初期仅启用 SSIM：`loss = MSE + w_ssim*(1-SSIM)`；调通后再加 LPIPS（低频计算或较小 w_lpips）。
4) 加入 `--val_hours`、`--val_downsample` 的验证指标输出，以 PSNR/SSIM/LPIPS 记录进度（验证阶段不反传）。

Step C：A/B 对比与网格调参（预计 0.5~1 天）
1) 四组配置：Baseline（现状）、BaselineEncoder、PatchSSIM、Hybrid（两者叠加）。
2) 指标：PSNR/SSIM/LPIPS + 整图推理时间（ms）。
3) 尝试网格：
	 - patch_size: [16,32]
	 - loss_ssim_w: [0.1,0.2,0.5]
	 - be_channels: [16,32]
	 - be_downsample: [1,2]

## 6. 评估与验收标准（Success Criteria）

- 在相同数据与 epoch 下，对比 Baseline：
	- SSIM 提升 ≥ +0.02（绝对值）或 LPIPS 降低 ≥ 0.02；
	- PSNR 下降 ≤ 0.3dB；
	- 推理耗时：GPU 1080p < 60ms（仅模型前向渲染，不含 IO）。
- 训练稳定性：loss 曲线稳定，无爆炸/NaN；学习率调度有效。
- 开关可控：关闭开关恢复旧行为；开启单项/双项均可运行且指标输出合理。

## 7. 依赖与环境

- 可选依赖：
	- SSIM：`pytorch-msssim`
	- LPIPS：`lpips`
- 安装（Windows cmd）：
```
python -m pip install -r pip_requirements.txt
```
（如未安装可选依赖，仅会跳过对应指标/损失计算）

## 8. 运行示例（当前功能，可直接复现）

- 训练（现有像素级 MSE）
```
python scripts\train.py --data_dir D:\Project\AIRender\data\tod_output ^
	--out_dir D:\Project\AIRender\runs\delta_small ^
	--epochs 20 --batch_size 8192 --hidden 64 --layers 6 ^
	--time_harmonics 4 --xy_harmonics 4 --xy_include_input ^
	--lr 5e-4 --num_workers 1 --samples_per_epoch 200000 ^
	--residual_mode True --baseline_time 12
```

- 推理（单次）
```
python scripts\infer.py --ckpt D:\Project\AIRender\runs\delta_small\best.ckpt ^
	--baseline_path D:\Project\AIRender\data\tod_output\tod_12.png ^
	--time 18 --out D:\Project\AIRender\runs\recon_18_with_base.png
```

- 批量推理（0~23 小时）
```
python scripts\batch_infer.py --ckpt D:\Project\AIRender\runs\delta_small\best.ckpt ^
	--infer_script scripts\infer.py --output_dir D:\Project\AIRender\runs\batch_infer ^
	--start_hour 0 --end_hour 23
```

## 9. 风险与应对

- LPIPS 训练过慢：先只启 SSIM；LPIPS 低频/小权重；或仅验证阶段计算。
- 显存压力：减小 patch_size；BaselineEncoder 下采样；半精度训练（AMP）。
- 指标波动：固定 seed、统一验证小时与下采样；增设 early-stop 观察点。

## 10. 下一步工作清单（可执行 TODO）

1) 接入 BaselineEncoder（训练/推理开关）
2) Dataset 支持 patch 模式与返回 patch 网格
3) 训练脚本支持 SSIM/LPIPS 损失权重与 LPIPS 低频开关
4) 验证钩子输出 PSNR/SSIM/LPIPS（val_hours/val_downsample）
5) A/B 四组对比 + 指标记录 + 简单表格汇总

---

附：可选的进一步优化方向（保持实时性）

- 瘦身与量化：更浅/窄 MLP + fp16/int8
- FiLM 调制：更强 time 条件化能力
- 哈希网格：2D+Time 多分辨率嵌入 + 极小 MLP
- 插值混合：若时间固定 24h，做邻时刻权重混合，进一步加速